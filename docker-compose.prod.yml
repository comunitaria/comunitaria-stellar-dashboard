services:
  nginx:
    image: nginx:alpine
    container_name: comunitaria-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/ssl:/etc/nginx/ssl:ro
      - ./docker/certbot-webroot:/var/www/certbot:ro
    depends_on:
      - app
    networks:
      - comunitaria-network

  certbot:
    image: certbot/certbot
    container_name: comunitaria-certbot
    volumes:
      - ./docker/ssl:/etc/letsencrypt
      - ./docker/certbot-webroot:/var/www/certbot
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/deploy-hook.sh:/etc/letsencrypt/renewal-hooks/deploy/01-reload-nginx.sh:ro
    entrypoint: "/bin/sh -c 'apk add --no-cache docker-cli && trap exit TERM; while :; do certbot renew --webroot --webroot-path=/var/www/certbot --deploy-hook \"/etc/letsencrypt/renewal-hooks/deploy/01-reload-nginx.sh\"; sleep 12h & wait $${!}; done;'"
    restart: unless-stopped
    networks:
      - comunitaria-network

  certbot-init:
    image: certbot/certbot
    container_name: comunitaria-certbot-init
    profiles:
      - setup
    volumes:
      - ./docker/ssl:/etc/letsencrypt
      - ./docker/certbot-webroot:/var/www/certbot
    command: certonly --webroot --webroot-path=/var/www/certbot --email luciano@supervecina.com --agree-tos --no-eff-email --non-interactive --keep-until-expiring -d dashboard.comunitaria.com
    networks:
      - comunitaria-network
